# テーブルテンプレート作成ガイド

## 概要

テーブルテンプレートは、よく使うテーブル構造を事前定義しておくことで、新規テーブル作成時に素早くカラム定義を設定できる機能です。

## テンプレートファイルの場所

```
backend/src/main/resources/table-templates.json
```

## テンプレートの構造

### 基本フォーマット

```json
{
  "templates": {
    "テンプレートキー": {
      "name": "表示名",
      "description": "テンプレートの説明",
      "columns": [
        {
          "name": "カラム名",
          "type": "データ型",
          "nullable": true/false,
          "primary": true/false,
          "autoIncrement": true/false,
          "defaultValue": "デフォルト値（オプション）",
          "comment": "カラムの説明（オプション）"
        }
      ]
    }
  }
}
```

### プロパティ説明

#### テンプレートレベル

| プロパティ | 必須 | 説明 | 例 |
|-----------|------|------|-----|
| `name` | ✅ | 管理画面に表示されるテンプレート名 | `"基本テーブル"` |
| `description` | ✅ | テンプレートの説明文 | `"ID、作成者、作成日時を含む基本的なテーブル"` |
| `columns` | ✅ | カラム定義の配列 | `[...]` |

#### カラムレベル

| プロパティ | 必須 | 説明 | 例 |
|-----------|------|------|-----|
| `name` | ✅ | カラム名（スネークケース推奨） | `"user_id"`, `"created_at"` |
| `type` | ✅ | データ型（MySQL準拠） | `"VARCHAR(100)"`, `"BIGINT"`, `"DATETIME"` |
| `nullable` | ✅ | NULL許可フラグ | `true`, `false` |
| `primary` | ❌ | 主キーフラグ | `true`, `false` |
| `autoIncrement` | ❌ | 自動採番フラグ（主キーと併用） | `true`, `false` |
| `defaultValue` | ❌ | デフォルト値 | `"CURRENT_TIMESTAMP"`, `"0"`, `"'active'"` |
| `comment` | ❌ | カラムのコメント | `"ユーザーID"`, `"作成日時"` |

### データ型一覧

#### 数値型
- `TINYINT` - 1バイト整数（-128〜127）
- `SMALLINT` - 2バイト整数（-32768〜32767）
- `INT` - 4バイト整数
- `BIGINT` - 8バイト整数
- `DECIMAL(M,D)` - 固定小数点数（例：`DECIMAL(10,2)`）
- `FLOAT` - 浮動小数点数
- `DOUBLE` - 倍精度浮動小数点数

#### 文字列型
- `CHAR(M)` - 固定長文字列（例：`CHAR(10)`）
- `VARCHAR(M)` - 可変長文字列（例：`VARCHAR(255)`）
- `TEXT` - 長文テキスト（最大65,535文字）
- `MEDIUMTEXT` - 中程度の長文テキスト
- `LONGTEXT` - 超長文テキスト

#### 日時型
- `DATE` - 日付（YYYY-MM-DD）
- `DATETIME` - 日時（YYYY-MM-DD HH:MM:SS）
- `TIMESTAMP` - タイムスタンプ
- `TIME` - 時刻（HH:MM:SS）
- `YEAR` - 年（YYYY）

#### その他
- `BOOLEAN` - 真偽値（TINYINTとして扱われる）
- `JSON` - JSON形式データ
- `BLOB` - バイナリデータ

## テンプレート例

### 1. 基本テーブル（ID + タイムスタンプ）

```json
"basic_table": {
  "name": "基本テーブル",
  "description": "ID、作成者、作成日時、更新者、更新日時を含む基本的なテーブル",
  "columns": [
    {
      "name": "id",
      "type": "BIGINT",
      "nullable": false,
      "primary": true,
      "autoIncrement": true,
      "comment": "主キー"
    },
    {
      "name": "created_by",
      "type": "VARCHAR(100)",
      "nullable": true,
      "comment": "作成者"
    },
    {
      "name": "created_at",
      "type": "DATETIME",
      "nullable": false,
      "defaultValue": "CURRENT_TIMESTAMP",
      "comment": "作成日時"
    },
    {
      "name": "updated_by",
      "type": "VARCHAR(100)",
      "nullable": true,
      "comment": "更新者"
    },
    {
      "name": "updated_at",
      "type": "DATETIME",
      "nullable": false,
      "defaultValue": "CURRENT_TIMESTAMP",
      "comment": "更新日時"
    }
  ]
}
```

### 2. ユーザーテーブル

```json
"user_table": {
  "name": "ユーザーテーブル",
  "description": "ユーザー情報を管理するテーブル",
  "columns": [
    {
      "name": "id",
      "type": "BIGINT",
      "nullable": false,
      "primary": true,
      "autoIncrement": true,
      "comment": "ユーザーID"
    },
    {
      "name": "username",
      "type": "VARCHAR(50)",
      "nullable": false,
      "comment": "ユーザー名"
    },
    {
      "name": "email",
      "type": "VARCHAR(255)",
      "nullable": false,
      "comment": "メールアドレス"
    },
    {
      "name": "password_hash",
      "type": "VARCHAR(255)",
      "nullable": false,
      "comment": "パスワードハッシュ"
    },
    {
      "name": "is_active",
      "type": "BOOLEAN",
      "nullable": false,
      "defaultValue": "true",
      "comment": "有効フラグ"
    },
    {
      "name": "created_at",
      "type": "DATETIME",
      "nullable": false,
      "defaultValue": "CURRENT_TIMESTAMP",
      "comment": "作成日時"
    },
    {
      "name": "updated_at",
      "type": "DATETIME",
      "nullable": false,
      "defaultValue": "CURRENT_TIMESTAMP",
      "comment": "更新日時"
    }
  ]
}
```

### 3. マスタテーブル

```json
"master_table": {
  "name": "マスタテーブル",
  "description": "コード値を管理するマスタテーブル",
  "columns": [
    {
      "name": "id",
      "type": "BIGINT",
      "nullable": false,
      "primary": true,
      "autoIncrement": true,
      "comment": "ID"
    },
    {
      "name": "code",
      "type": "VARCHAR(50)",
      "nullable": false,
      "comment": "コード"
    },
    {
      "name": "name",
      "type": "VARCHAR(255)",
      "nullable": false,
      "comment": "名称"
    },
    {
      "name": "display_order",
      "type": "INT",
      "nullable": false,
      "defaultValue": "0",
      "comment": "表示順"
    },
    {
      "name": "is_active",
      "type": "BOOLEAN",
      "nullable": false,
      "defaultValue": "true",
      "comment": "有効フラグ"
    }
  ]
}
```

### 4. 商品テーブル

```json
"product_table": {
  "name": "商品テーブル",
  "description": "商品情報を管理するテーブル",
  "columns": [
    {
      "name": "id",
      "type": "BIGINT",
      "nullable": false,
      "primary": true,
      "autoIncrement": true,
      "comment": "商品ID"
    },
    {
      "name": "product_code",
      "type": "VARCHAR(50)",
      "nullable": false,
      "comment": "商品コード"
    },
    {
      "name": "product_name",
      "type": "VARCHAR(255)",
      "nullable": false,
      "comment": "商品名"
    },
    {
      "name": "description",
      "type": "TEXT",
      "nullable": true,
      "comment": "商品説明"
    },
    {
      "name": "unit_price",
      "type": "DECIMAL(10,2)",
      "nullable": false,
      "comment": "単価"
    },
    {
      "name": "stock_quantity",
      "type": "INT",
      "nullable": false,
      "defaultValue": "0",
      "comment": "在庫数"
    },
    {
      "name": "is_available",
      "type": "BOOLEAN",
      "nullable": false,
      "defaultValue": "true",
      "comment": "販売可能フラグ"
    },
    {
      "name": "created_at",
      "type": "DATETIME",
      "nullable": false,
      "defaultValue": "CURRENT_TIMESTAMP",
      "comment": "作成日時"
    },
    {
      "name": "updated_at",
      "type": "DATETIME",
      "nullable": false,
      "defaultValue": "CURRENT_TIMESTAMP",
      "comment": "更新日時"
    }
  ]
}
```

## テンプレートの追加手順

### 1. ファイルを編集

```bash
backend/src/main/resources/table-templates.json
```

を開き、`templates` オブジェクト内に新しいテンプレートを追加します。

### 2. JSON構文チェック

- カンマの位置に注意（最後の要素の後にはカンマ不要）
- 文字列は必ずダブルクォート `"` で囲む
- ブール値は `true`/`false`（小文字、クォート不要）

### 3. バックエンドを再起動

リソースファイルの変更を反映するため、バックエンドを再起動します：

```powershell
# PowerShell
Get-Process -Name java -ErrorAction SilentlyContinue | Stop-Process -Force
cd C:\work\projects\thinking\TableCraft\backend
mvn spring-boot:run '-Dspring-boot.run.profiles=dev'
```

または、`start-system.bat` を実行して全体を再起動。

### 4. 管理画面で確認

1. ブラウザで管理画面を開く（http://localhost:5175）
2. サイドバーの「テーブル設定」→「📋 テンプレートから作成」をクリック
3. ドロップダウンに新しいテンプレートが表示されることを確認
4. テンプレートを選択してカラムが正しく設定されるか確認

## トラブルシューティング

### テンプレートが表示されない

**原因1**: JSON構文エラー
- オンラインJSON検証ツール（https://jsonlint.com/）でファイルをチェック
- カンマの位置、括弧の対応を確認

**原因2**: バックエンドが再起動されていない
- バックエンドを停止して再起動

**原因3**: ファイルパスが間違っている
- `backend/src/main/resources/table-templates.json` に配置されているか確認

### テンプレート選択後にカラムが表示されない

**原因**: `columns` 配列が空、または必須プロパティが不足
- `name`, `type`, `nullable` は必須
- 配列の構文が正しいか確認（`[]` で囲む）

### バックエンドでエラーが発生

**コンソールログを確認**:
```
Failed to load default config: table-templates.json
```

このエラーが出た場合は、JSON構文エラーの可能性が高いです。

## ベストプラクティス

### 命名規則

- **テンプレートキー**: スネークケース（例：`user_table`, `order_detail_table`）
- **カラム名**: スネークケース（例：`user_id`, `created_at`）
- **表示名**: 日本語OK（例：`"ユーザーテーブル"`）

### カラム構成の推奨パターン

#### 1. 必ず含めるカラム
```json
{
  "name": "id",
  "type": "BIGINT",
  "nullable": false,
  "primary": true,
  "autoIncrement": true,
  "comment": "主キー"
}
```

#### 2. 作成・更新情報
```json
{
  "name": "created_at",
  "type": "DATETIME",
  "nullable": false,
  "defaultValue": "CURRENT_TIMESTAMP",
  "comment": "作成日時"
},
{
  "name": "updated_at",
  "type": "DATETIME",
  "nullable": false,
  "defaultValue": "CURRENT_TIMESTAMP",
  "comment": "更新日時"
}
```

#### 3. 論理削除フラグ（必要に応じて）
```json
{
  "name": "is_deleted",
  "type": "BOOLEAN",
  "nullable": false,
  "defaultValue": "false",
  "comment": "削除フラグ"
}
```

### デフォルト値の書き方

#### 文字列
```json
"defaultValue": "'active'"  // シングルクォートで囲む
```

#### 数値
```json
"defaultValue": "0"  // クォートで囲む（文字列として）
```

#### 日時関数
```json
"defaultValue": "CURRENT_TIMESTAMP"  // クォート不要
```

#### NULL
```json
"defaultValue": "NULL"  // クォート不要
```

## まとめ

- テンプレートファイルは `backend/src/main/resources/table-templates.json`
- JSON形式で定義、構文チェックを忘れずに
- 追加後はバックエンドを再起動
- 管理画面の「テンプレートから作成」で確認

テンプレートを活用することで、テーブル作成作業を大幅に効率化できます！
